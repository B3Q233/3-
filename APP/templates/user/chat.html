<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Chat UI with Layui</title>
    <style>
        /* 去除body原有的一些布局相关样式设置 */
        body {
            background-color: #ffffff;
            /* 将body背景色改为白色 */
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }

        /* 聊天容器，设置宽度、高度、背景、边框、圆角等样式，使其更具立体感和美观性，让其能填充父容器（也就是layui-body） */
    .layui-container {
            width: 100%;
            height: 100%;
            background-color: #f9f9f9;
            /* 容器背景色改为浅灰色，稍显柔和 */
            border: 1px solid #e6e6e6;
            /* 边框颜色保持浅灰色 */
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }


        /* 聊天内容展示区域，设置内边距、溢出处理及滚动条样式，让聊天消息显示更规整美观，使其能自动填充剩余空间 */
    .layui-card-body {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #ccc #f9f9f9;
            /* 滚动条颜色适配背景 */
            background-color: #f9f9f9;
            /* 内容展示区域背景色与容器一致 */
        }

        /* 针对不同浏览器自定义滚动条样式（WebKit 内核浏览器，如Chrome、Safari等） */
    .layui-card-body::-webkit-scrollbar {
            width: 8px;
        }

    .layui-card-body::-webkit-scrollbar-track {
            background-color: #f9f9f9;
            /* 滚动条轨道颜色与内容展示区背景一致 */
        }

    .layui-card-body::-webkit-scrollbar-thumb {
            background-color: #ccc;
            /* 滚动条滑块颜色为浅灰色 */
            border-radius: 4px;
        }

        /* 聊天消息样式，区分不同发送者，设置不同的颜色、边距等，增强可读性 */
    .chat-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            max-width: 80%;
            word-wrap: break-word;
        }

    .chat-message.you {
            background-color: #e6f7ff;
            /* 发送者消息背景色为浅蓝色，清新感 */
            color: #0056b3;
            /* 文字颜色与背景搭配协调 */
            align-self: flex-end;
        }

        /* 接收者消息背景色调浅，与整体风格适配 */
    .chat-message.gpt {
            background-color: #f0f0f0;
            color: #333;
            align-self: flex-start;
        }

        /* 聊天输入框区域，设置内边距、背景色等，使其与整体风格协调 */
    .layui-card-footer {
            padding: 15px;
            background-color: #f9f9f9;
            /* 输入框区域背景色与容器一致 */
        }

        /* 输入框样式，设置宽度、高度、边框、圆角等，使其更加美观 */
    .layui-input {
            width: 100%;
            height: 40px;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 0 10px;
            background-color: white;
            /* 输入框背景色为白色 */
            color: #333;
            /* 输入框文字颜色为深灰色 */
        }

        /* 发送按钮样式，设置背景色、文字颜色、鼠标悬停效果等，提升交互性 */
    .layui-btn {
            background-color: #16baaa;
            /* 发送按钮背景色为主题色 */
            color: white;
            /* 文字颜色为白色 */
            height: 40px;
            line-height: 40px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        /* 按钮悬停时背景色稍变深，体现交互效果 */
    .layui-btn:hover {
            background-color: #009688;
        }
    </style>
</head>

<body>

    <div class="layui-container">
        <div class="layui-row">
            <div class="layui-col-md12">
                <div class="layui-card">
                    <div class="layui-card-body">
                        <!-- 聊天内容展示区域 -->
                        <div id="chat-messages" style="height: 560px;"></div>
                    </div>
                    <div class="layui-card-footer">
                        <form class="layui-form" action="" onsubmit="return false;">
                            <div class="layui-form-item">
                                <div class="layui-input-inline" style="width: 80%;">
                                    <input type="text" name="message" lay-verify="required" placeholder="请输入消息..."
                                        autocomplete="off" class="layui-input">
                                </div>
                                <div class="layui-input-inline" style="width: 15%;">
                                    <button class="layui-btn" lay-submit lay-filter="sendMessage">发送</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script>
            // 显示消息函数，添加类名来区分不同发送者的消息样式
            function displayMessage(username, message) {
                let chatMessages = document.getElementById('chat-messages');
                let newMessage = document.createElement('div');
                newMessage.className = `chat-message ${username === 'You'? 'you' : 'gpt'}`;

                // 更完善的Markdown到HTML转换，处理代码块等情况
                let lines = message.split('\n');
                let parsedMessage = '';
                let inCodeBlock = false;
                let codeBlockLanguage = '';
                for (let line of lines) {
                    if (line.startsWith('```')) {
                        if (inCodeBlock) {
                            // 结束代码块，添加高亮
                            let code = document.createElement('pre');
                            let codeInner = document.createElement('code');
                            codeInner.textContent = codeBlockContent;
                            codeInner.className = `language-${codeBlockLanguage}`;
                            hljs.highlightElement(codeInner);
                            code.appendChild(codeInner);
                            parsedMessage += code.outerHTML;
                            inCodeBlock = false;
                        } else {
                            // 开始代码块，获取语言标识
                            codeBlockLanguage = line.slice(3).trim().toLowerCase();
                            if (hljs.getLanguage(codeBlockLanguage)) {
                                codeBlockContent = '';
                                inCodeBlock = true;
                            } else {
                                // 不支持的语言，当作普通文本处理
                                parsedMessage += line + '\n';
                            }
                        }
                    } else if (inCodeBlock) {
                        codeBlockContent += line + '\n';
                    } else {
                        // 普通文本行，进行常规的Markdown转换
                        line = line
                         .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // 加粗
                         .replace(/\*(.*?)\*/g, '<em>$1</em>') // 斜体
                         .replace(/`(.*?)`/g, '<code>$1</code>') // 代码（非代码块内的）
                         .replace(/^#+\s+(.*)$/gm, function (match, p1) {
                                let level = match.match(/#+/)[0].length;
                                return `<h${level}>${p1}</h${level}>`; // 标题转换
                            })
                         .replace(/^\*\s+(.*)$/gm, '<li>$1</li>') // 无序列表项
                         .replace(/^[0-9]+\.\s+(.*)$/gm, '<li>$1</li>') // 有序列表项
                         .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2">$1</a>') // 链接
                         .replace(/!\[(.*?)\]\((.*?)\)/g, '<img src="$2" alt="$1">') // 图片
                         .replace(/\n/g, '<br>');
                        parsedMessage += line;
                    }
                }

                newMessage.innerHTML = `<strong>${username}:</strong>${parsedMessage}`;
                chatMessages.appendChild(newMessage);
                newMessage.scrollIntoView(false);
            }

            // 新增的显示图片函数
            function displayImg(url, username) {
                let chatMessages = document.getElementById('chat-messages');
                let imgElement = document.createElement('img');
                imgElement.src = url;
                imgElement.alt = '聊天消息中的图片';
                imgElement.style.maxWidth = '700%'; // 确保图片宽度自适应，不超出聊天消息区域
                imgElement.style.borderRadius = '4px'; // 给图片添加圆角，与消息样式统一
                imgElement.style.marginBottom = '10px'; // 图片下方添加一点间距

                let imgMessage = document.createElement('div');
                imgMessage.className = `chat-message ${username === 'You'? 'you' : 'gpt'}`;
                imgMessage.appendChild(imgElement);
                chatMessages.appendChild(imgMessage);

                imgElement.scrollIntoView(false);
                imgMessage.scrollIntoView(false);
                chatMessages.scrollIntoView(false);

            }

    function sendMsg(msg) {
            let selectedModel = localStorage.getItem("selectedModel");
            let selectedModel1 = JSON.parse(selectedModel);
            layui.use(['jquery', 'layer'], function () {
                let $ = layui.jquery;
                let layer = layui.layer;
                localStorage.setItem('oldSelectedModel', JSON.stringify({ 'model_id': selectedModel1.model_id }));

                // 发送AJAX请求
                $.ajax({
                    url: '/user/AI_chat',
                    type: 'POST',
                    contentType: 'application/json',
                    dataType: "json",
                    data: {
                        user_id: localStorage.getItem('user_id'),
                        msg: msg,
                        model: selectedModel
                    },
                    success: function (response) {
                        let img = 0;
                        let lastSelectedModel = JSON.parse(localStorage.getItem('oldSelectedModel'));
                        let selectedModel = JSON.parse(localStorage.getItem("selectedModel"));
                        if (lastSelectedModel.model_id === selectedModel.model_id) {
                            if (response.msg[0] && response.msg[0].url) {
                                // 如果消息中有图片url，调用displayImg函数显示图片
                                displayImg(response.msg[0].url, 'gpt');
                                img = 1;
                            } else {
                                displayMessage('gpt', response.msg);
                                img = 0;
                            }
                        }

                        // 将新的聊天记录添加到对应模型id的聊天记录数组中
                        let modelId = selectedModel1.model_id;
                        if (!modelChatRecords[modelId]) {
                            modelChatRecords[modelId] = [];
                        }
                        modelChatRecords[modelId].push({
                            sender: 'You',
                            message: msg
                        });
                        if (img === 1) {
                            modelChatRecords[modelId].push({
                                sender: 'gpt',
                                message: response.msg[0].url
                            });
                        } else {
                            modelChatRecords[modelId].push({
                                sender: 'gpt',
                                message: response.msg
                            });
                        }
                        liao = 1;
                    },
                    error: function (xhr, status, error) {
                        showError('AJAX请求失败:', error);
                    }
                });
            });
        }

    $(document).ready(function () {
            let selectedModel = JSON.parse(localStorage.getItem('selectedModel'));
            let modelId = selectedModel? selectedModel.model_id : null;
            if (modelId) {
                // 检查是否有对应模型的聊天记录
                if (modelChatRecords[modelId] && modelChatRecords[modelId].length > 0) {
                    // 有聊天记录，加载并展示
                    modelChatRecords[modelId].forEach(record => {
                        if (record.message.startsWith('http') && (record.message.endsWith('.jpg') || record.message.endsWith('.png') || record.message.endsWith('.jpeg') || record.message.endsWith('.gif'))) {
                            // 判断如果消息是以图片常见格式的url开头和结尾，认为是图片链接，调用displayImg函数展示
                            displayImg(record.message, record.sender);
                        } else {
                            // 否则认为是普通文本消息，调用displayMessage函数展示
                            displayMessage(record.sender, record.message);
                        }
                    });
                } else {
                    // 无聊天记录，显示初始文本（假设initial_text仍按原来方式获取）
                    let initial_text = JSON.parse(localStorage.getItem('selectedModel'))['initial_text'];
                    displayMessage('gpt', initial_text);
                }
            }
            // 监听表单提交事件
            layui.use(['form'], function () {
                let form = layui.form;

                // 监听发送消息按钮
                form.on('submit(sendMessage)', function (data) {
                    if (liao == 0) return false;
                    liao = 0;
                    let message = data.field.message;
                    sendMsg(message);
                    // 显示消息
                    displayMessage('You', message);
                    // 清空输入框
                    $('input[name="message"]').val('');
                    return false;
                });
            });
        });
    </script>

</body>

</html>